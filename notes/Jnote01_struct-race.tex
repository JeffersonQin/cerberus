\documentclass[a4paper,11pt]{article}

\usepackage[utf8]{inputenc}
\usepackage[british]{babel}
\usepackage{listings}
\usepackage{courier}

\lstset{
  language=C,
  basicstyle=\ttfamily,
  frame=none,
  escapechar=£
}

\usepackage{color}
\definecolor{highlight}{gray}{0.90}

\usepackage{hyperref}

\title{Unsequenced side effects on structures}
\date{9th October 2012}

\begin{document}
\maketitle

\section{Issue}

The new C11 standard only seems to make unsequenced races on {\em
  scalar objects}, but not on {\em aggregate objects}, undefined. The
C11 (6.5, paragraph 2) and the C\lstinline{++}11 (1.9, paragraph 15)
standards identically say (emphasis mine):
\begin{quote}
  If a side effect on {\em a scalar object} is unsequenced relative to either
  another side effect on the same scalar object or a value computation using
  the value of the same scalar object, the behavior is undefined.
\end{quote}
However, it is easy to produce a program that contains an unsequenced race on a structure.
\begin{lstlisting}
struct T {int  i;}
  t,
  t1 = {.i = 1},
  t2 = {.i = 2};

int main(void) {
  return £\colorbox{highlight}{(t = t1).i + (t = t2).i}£;
}
\end{lstlisting}
The two assignments to \lstinline{t} are unsequenced but the program
can only make sense if they are executed in some sequential
order. Thus, restricting the above clause to scalar objects looks like
a mistake to me.

\section{History}
The equivalent clause in C99
\begin{quote}
  Between the previous and next sequence point {\em an object} shall have its
  stored value modified at most once by the evaluation of an expression.
\end{quote}
was more general and made the example undefined. The restriction to
scalar objects entered the C standard via C\lstinline{++};
C\lstinline{++}98 already contained the restriction
\begin{quote}
  Between the previous and next sequence point {\em a scalar object} shall
  have its stored value modified at most once by the evaluation of an
  expression.
\end{quote}
and it was maintained in the squenced-before
proposal\footnote{\url{http://www.open-std.org/jtc1/sc22/wg14/www/docs/n1252.htm}},
which C11 also adopted.

\end{document}

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: t
%%% End: 
